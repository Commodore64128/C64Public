;main test code

!source "stdlib/stdlib.a"
!to "bin/main.prg", cbm
!sal
!sl "tmp/main.map"
!svl "tmp/main.lbl"
!pdb "tmp/main.pdb"
!cpu 6510
!ct pet

zeroPage_Temp0	= $02
zeroPage_Temp1	= $03



!zn
*=$200
	jmp start
	
!source "tmp/FingerPrint.a"

Initialise_NoMACROWaitForTheLastScan = 1
Initialise_NoIRQServiceRoutine = 1
!source "stdlib/Initialise.a"
!source "BombJack/stdlib/Bus24Bit.a"
!source "BombJack/stdlib/Video.a"

!zn
start
	sei
	lda #ProcessorPortAllRAMWithIO
	jsr InitialiseMachine
	jsr Bus24Bit_Init
	jsr Bus24Bit_DisableDisplay

	jsr AnimationEngine_Init

	; Do various video data init here

	; No large sprites
	jsr Bus24Bit_SetAddressSpritesControl
	lda #$10
	sta CIA2PortBRS232
	lda #$00
	sta CIA2PortBRS232

	; Enable screen, tiles, border shrink
	lda #$f0
	jsr Bus24Bit_EnableDisplay
	jsr Bus24Bit_WaitVSync

	; Allocate and remember the player index
	ldy #kAnimationType_playerRunLeft
	jsr AnimationEngine_Allocate
	lda #120
	sta AnimationEngine_posX,x
	lda #128
	sta AnimationEngine_posY,x
	lda #kAnimationEngine_flipX
	sta AnimationEngine_flips,x
	stx playerAnimationIndex


	ldy #kAnimationType_playerRunLeft
	jsr AnimationEngine_Allocate
	lda #32
	sta AnimationEngine_posX,x
	lda #96
	sta AnimationEngine_posY,x


	ldy #kAnimationType_playerRunUp
	jsr AnimationEngine_Allocate
	lda #192
	sta AnimationEngine_posX,x
	lda #160
	sta AnimationEngine_posY,x


	ldy #kAnimationType_playerRunLeft
	jsr AnimationEngine_Allocate
	lda #48
	sta AnimationEngine_posX,x
	lda #220
	sta AnimationEngine_posY,x


	ldy #kAnimationType_playerRunDown
	jsr AnimationEngine_Allocate
	lda #96
	sta AnimationEngine_posX,x
	lda #64
	sta AnimationEngine_posY,x


	ldy #kAnimationType_playerRunUp
	jsr AnimationEngine_Allocate
	lda #196
	sta AnimationEngine_posX,x
	lda #100
	sta AnimationEngine_posY,x


	ldy #kAnimationType_playerRunLeft
	jsr AnimationEngine_Allocate
	lda #150
	sta AnimationEngine_posX,x
	lda #132
	sta AnimationEngine_posY,x

mainLoop
.l1
	jsr setupFrame
	inc VIC2BorderColour
	jmp .l1

setupFrame
	jsr Bus24Bit_WaitVSync
	jsr copyMode7Regs
	jsr copyTilesScrolls
	jsr copySprites
	jsr HandleJoystick
	jsr AnimationEngine_Update
	jsr CharacterLogic_Update
	jsr Mode7_Update
	rts

!source "asm/TileScreen.a"
!source "asm/AnimationEngine.a"
!source "asm/PlayerInput.a"
!source "asm/Mode7.a"
!source "asm/StackedSprites.a"
!source "asm/AnimationData.a"
!source "../BerzerkRedux/Rand.a"
!source "asm/CharacterLogic.a"
